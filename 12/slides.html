<!DOCTYPE html>
<html>
  <head>
    <!--<title>My Awesome Presentation</title>-->
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
    <link rel="stylesheet" type="text/css" href="../slides.css">
    <script src="../remark.min.js"></script>
  </head>
  <body>
    <textarea id="source">

class: title, center, middle

# Операционные системы

## Многопроцессорные системы
---
# Мультипроцессоры

Типы многопроцессорных систем:
* мультипроцессоры
* мультикомпьютеры

.def[Мультипроцессор] - несколько процессоров имеют доступ к общей оперативной памяти.

Примеры: многопроцессорные, многоядерные машины.

Доступ к памяти:
* UMA (Uniform Memory Access) - время доступа не зависит от процессора или области памяти
* NUMA (Nonniform Memory Access) - в противном случае

UMA с шинной архитектурой:

```asciidrawing
+-----+  +-----+  +-----+
| CPU |  | CPU |  | Mem |
+--+--+  +--+--+  +--+--+
   |        |        |
+--+--------+--------+--+
+-----------------------+
```

---
# UMA
UMA с координатным коммутатором:

```asciidrawing

         +-----+  +-----+  +-----+
         | Mem |  | Mem |  | Mem |
         +--+--+  +--+--+  +--+--+
            |        |        |
+-----+     |        |        |
| CPU +-----o--------+--------+--
+-----+     |        |        |
            |        |        |
+-----+     |        |        |
| CPU +-----+--------+--------o--
+-----+     |        |        |
            |        |        |
+-----+     |        |        |
| CPU +-----+--------o--------+--
+-----+     |        |        |

```
---
# UMA

.def[Omega network]: Lawrie, D. H. (1975). Access and alignment of data in an array processor

.f75img[![](Omega_Network.jpg)]

.def[Perfect shuffle]: `abcde` -> `bcdea`

---
# NUMA

```asciidrawing
                          Directory
+-----+  +-----+  +-----+ +--+
| CPU |  | CPU |  | CPU | +--+
+--+--+  +--+--+  +--+--+ +--+
   +--...   +--...   +----+--+ +-----+
   +--...   +--...   +---------+ Mem |
+--+--------+--------+--+      +-----+
+-----------------------+
```

Мы будем считать .def[многопроцессорные] машины и машины с .def[многоядерными] процессорами NUMA машинами
* ядра и процессоры могут обладать индивидуальными кешами

---
# ОС для мультипроцессоров
* Собственная ОС
* Ассиметричные мультипроцессоры
* Симметричные мультипроцессоры

---
# ОС для мультипроцессоров

Собственная ОС для каждого процессора:
* каждой ОС (экземпляру) отводится отдельная область памяти.

Достоинства:
* простота реализации
* ОС работают независимо, повышается надёжность, безопасность

Недостатки:
* процессы не мигрируют: неравномерная загрузка
* дублирование программных кешей
* статическое распределение памяти

---
# ОС для мультипроцессоров

AMP (Assymetric Multiprocessor):
* один управляющий исполняющий ядро ОС
* другие процессоры исполняют только пользовательский код
* исключения (в т.ч. системные вызовы) обрабатываются на управляющем.

Достоинства:
* Распределение ресурсов
* Возможно использовать процессоры разных архитектур

Недостатки:
* Управляющий процессор - узкое место
* Усложнение ОС: одна версия для управляющего процессора, другая для рабочих процессоров

---
# ОС для мультипроцессоров

SMP (Symmetric Multiprocessor): процессоры равноправны
 * каждый исполняет экземпляр одной ОС,
 * каждый может управлять всеми ресурсами: память, внешние устройства...
 * важна синхронизация между ними

---
# Планирование мультипроцессоров

Организация очереди:
* единая очередь
* по очереди на процессор
 * периодически балансировать задачи
 * job stealing

Одна из задач планирования: стараться не перемещать процессы на другой процессор (unix: get/setaffinity)

The Linux Scheduler: a Decade of Wasted Cores (http://www.i3s.unice.fr/~jplozi/wastedcores/)
---
# Реентерабельность
.def[Реентерабельность] - свойство частей программ, позволяющее выполнять одну и ту же последовательность инструкций нескольким параллельно.

Нереентерабельные части должны быть защищены.

`irq_lock`/`unlock` в мультипроцессорной среде недостаточно для обеспечения атомарности последовательности инструкций.

Нужен специальный примитив, обеспечивающий атомарность в мультипроцессорной среде.



---
# spinlock

.def[spinlock] - примитив для реализации критических секций для мультипроцессоров.
Реализуется на основе цикла -- отсюда и название.

Примерная реализация:

```
spin_lock(spin_t *spin) {
        while (true == test_and_set(spin));
}

spin_unlock(spin_t *spin) {
        *spin = false;
}
```

Реализация не корректна: не учитваются кэши.

Наивный подход требует постоянного блокирование шины, что может быть дорого (~100 тактов).

Исследования сосредоточены на создании lock-free и wait-free алгоритмов.

---
# Мультикомпьютеры

Системы, с собственным процессором и оперативной памятью, возможно, без накопительных устройств.

Например, мультикомпьютер из машин сопоставимых с ПК, но соединенных высокопроизводительной сетью.

Способы взаимодействия узлов:
* Посылка сообщений:
  * send/receive
* Удалённый вызов
  1. Вызов обычной функции,
  2. которая отправляет сообщение
  3. По приёму сообщения,
  4. вызывается требуемая функций
* Обмен страницами: создание видимости общей памяти
  * каждой страницей владеет один узел
  * при обращении узла к странице, находящейся на другом узле, она перемещается
  * важно обеспечивать минимальное количество перемещений страниц
  * неизменяемые страницы можно .def[реплицировать] - содержать копию на нескольких узлах

    </textarea>
    <script src="../slides.js" type="text/javascript"></script>
  </body>
</html>
