<!DOCTYPE html>
<html>
  <head>
    <!--<title>My Awesome Presentation</title>-->
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
    <link rel="stylesheet" type="text/css" href="../slides.css">
    <script src="../remark.min.js"></script>
  </head>
  <body>
    <textarea id="source">

class: title, center, middle

# Операционные системы

## Взаимодействие ОС и программы. Методы организации ОС

---
# ОС - виртуальная машина

```asciidrawing

             OS                        os226

        +------------------+    +------------------+
        |        App       |    |       App        | (процедура)
    +---+------------------+    +------------------+
    |         OS           |    |      OS (VM)     | (программа)
    +------------------+---+    +------------------+
    |     Hardware     |        |     Hardware     | (ВМ хост-ОС)
    +------------------+        +------------------+
```

Пока os226 просто большая программа:
 * виртуальная машина совпадает с физической
 * программы - процедуры -- как загружать программы?:
--

* линковка во время загрузки
* динамическая линкова

---
# `gdb hello`

```
int main(int argc, char *argv[]) {
        const char *msg = "Hello, World!\n";
        write(1, msg, strlen(msg));
        return 0;
}
```
--
```
(gdb) disas write
   ...
   0x000000000043bbea <+10>:    mov    $0x1,%eax
   0x000000000043bbef <+15>:    syscall
   ...
```
Инструкция `syscall` процессора x86-64 генерирует .def[исключение].

---
# Исключения

```asciidrawing
        +--------+       +--------+      +---------+
        |  CPU   |       | Memory |      |   I/O   |
        +--------+       +--------+      +---------+
            ^                ^                ^
            |                |                |
            v                v                v
Bus +---------------------------------------------------
    +---------------------------------------------------
```
.def[Исключение] - событие, при котором процессор переходит на заранее определённый обработчик (процедуру)

1. Синхронные (внутренние)
 1. деление на ноль
 2. ошибки доступа к памяти
 3. инструкции программных исключений
 4. ...
2. Асинхронные (внешние)
 1. прерывания

---
# Режимы работы CPU

```asciidrawing
          +------------------+
          | Пользовательский |
          +------------------+
             |          ^
  Исключение |          | Выход из обработчика
             v          |
          +------------------+
          |    Системный     |
          +------------------+
```

В пользовательском режиме часть инструкций и регистров заблокирована:

```asciidrawing
        +--------------+
        |     App      |
    +---+--------------+
    |         OS       |
    +------------------+
    |     Hardware     |
    +------------------+
```

.def[Ядро] - участок ОС, исполняющийся в системном режиме (привелегированном, режиме супервизора).

---
# Обработка исключений

Полная последовательность обработки: (* -- реализуется аппаратурой):
1. (*) Сохранение базового контекста CPU
2. (*) Подготовка и переключение в контекст обработки исключения
3. Сохранение полного контекста (например, код ядра меняет несохраннёную часть контекста => нужно сохранить)
4. Обработка исключения
5. Acknowledgement исключения
6. Восстановление контекста

.def[Системный вызов] - исключение с семантикой вызова (определённой функции ядра).
Системный вызов может менять контекст: функция возвращает результат.

ОС расширяет машину системными вызовами:


```asciidrawing
        +------------------+
        |        App       |
    +---+------------------+
    |         OS           |
    +------------------+---+
    |     Hardware     |
    +------------------+
```
---

Так же, как процессор получает исключения, программы в UNIX получают .def[сигналы].

Часть определения .def[сигнала] - событие получаемое программой при исполнении некорректной инструкции:
 * неопределённая инструкция
 * привелегированная инструкция (только в системном режиме)
 * инструкция с некорректными аргументами (доступ по неправильному адресу, деление на ноль,...)

Поведение по умолчанию: завершить программу.

Может быть переопределено: вызвать заранее установленную функцию-обработчик.

```
void hnd(int sig) { ... }

        signal(SIGSEGV, hnd);
```
 ---
```
void hnd(int sig, siginfo_t *info, void *ctx) { ... }

       struct sigaction act = { .sa_sigaction = sighnd };
       sigaction(SIGSEGV, &act, NULL);
```

Для x86-64: "System V Application Binary SIGSEGV",

https://www.uclibc.org/docs/psABI-x86_64.pdf

---
# Типы ОС

* .def[Монолитные] - все функции находятся в ядре.

 Например, UNIX, в ядре:
 * Планировщик
 * Драйвера устройств
 * Сетевые протоколы, файловые системы
 * Реализация системных вызовов ФС, сети,...

* .def[Микроядерные] - только минимальная часть в ядре.

  Например, MINIX/L4, в ядре:
  * планировщик
  * исключения
  * обмен сообщениями между процессами

 Всё остальное реализуется системными процессами.

* .def[Экзоядерные] - ядра нет/только мультиплексоры устройств

    </textarea>
    <script src="../slides.js" type="text/javascript"></script>
  </body>
</html>
